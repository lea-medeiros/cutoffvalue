---
title: "Cutoff Value Determination & Graph"
author: "Lea R. Medeiros"
date: "2024-11-27"
output:
  html_document:
    keep_md: yes
---

```{r setup-chunk, include=FALSE}
knitr::opts_chunk$set(
 fig.align = 'center', fig.height = 8, fig.width = 10,
 fig.path='cutoffvalue_figures/',
 dpi = 300,
 dev = c('jpeg', 'pdf', 'png'),
 echo = FALSE,
 cache = TRUE)
```

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.


### Setup RStudio
Load the packages that are used by this package.
```{r load_packages, echo=TRUE}
library(mixtools)
library(Hmisc)
library(plyr)
library(multimode)
library(readxl)
```


## Load your data
### Define your raw dataset
Specify the data file to be used in the analyses and graph (if located in R project folder, path information is not necessary). Reminder: data should be organized in as a single column of log- or natural log-transformed data without a column header.
```{r define_your_data, echo=TRUE}
rawdata <- "exampledata.xlsx"
```
_This step isn't necessary if you'd rather use the path name for your data._

### Import the raw dataset
Import data and remove rows containing NA data and define minimum and maximum values for the dataset.
```{r import_your_data, echo=TRUE}
rawdata <- read_excel(rawdata)
data_na <- na.omit(rawdata)
mydata <- data_na[[1]]
mydata.upper <- max(mydata)
mydata.lower <- min(mydata)
```
_Alternatively, you could enter the path name of your data in the read_excel function_

## Determine modality
Determine if the data is not unimodal (e.g., bimodal).
```{r modetest}
modetest(mydata)
```

```{r mode1, include=FALSE}
modes <- modetest(mydata$data)
pvalue <- modes$p.value
```

```{r mode_eval}
if(pvalue > 0.05) {
  print('**Accept null hypothesis.** Proceed with caution.')
}
print('**Reject null hypothesis**, accept alternative hypothesis. Proceed with analyses.')
```
_Returns excess mass statistic and p-value. If the p-value is less than 0.05, accept the alternative hypothesis and proceed with analysis. However, if the p-value is more than 0.05, the data is unimodal and the following analyses are not entirely valid._

## Fit a model to the data
Fit the two component mixture models to the data and plot a rough histogram with the fitted lines. Also, define the index.lower value to be used in the find.cutoff function.
```{r model_data}
mydata_model <- normalmixEM(mydata)
plot(mydata_model, whichplots = 2)
index.lower <- which.min(mydata_model$mu)
```
_Make sure things look right, but won’t actually use this graph as it plots on a density scale and may cause confusion. However, this should look pretty spot on (final graph will just be scaled up by a constant determined later on), so make sure that the point where the two curves intersect is where you are expecting the cutoff to be._

## Determine the cutoff value
Determine the cutoff value between the two populations that has an equal chance of being drawn from either mode. The default is 0.5, but the probability can be changed in the code.
```{r find_cutoff, results='asis'}
find.cutoff <- function(proba=0.5, i=index.lower) {
  ## Cutoff such that Pr[drawn from bad component] == proba
  f <- function(x) {
    proba - (mydata_model$lambda[i]*dnorm(x, mydata_model$mu[i], mydata_model$sigma[i]) /
               (mydata_model$lambda[1]*dnorm(x, mydata_model$mu[1], mydata_model$sigma[1]) +
                  mydata_model$lambda[2]*dnorm(x, mydata_model$mu[2], mydata_model$sigma[2])))
  }
  return(uniroot(f=f, lower=mydata.lower, upper=mydata.upper)$root)
}
cutoff <- find.cutoff()
```
```{r}
returnValue(cutoff)
```
_The uniroot lower and upper values are determined using the range of "mydata" and will reflect the dataset being analyzed. If there are errors due to the uniroot, consider editing the custom values to something that more generally refelcts the range of the data being analyzed._

## Basic histogram and parameters
The code below will produce basic histogram of data used for the parameters it produces; alter number of breaks to reflect what you would like to see in the final graph. Then, use various parameters to define variables for the final graph
```{r basic_histogram}
h <- hist(mydata, breaks=15)
xlim.upper <- round(mydata.upper*2)/2
xlim.lower <- (round(mydata.lower*2)/2)-0.25
ylim.upper <- round_any(max(h$counts), 5)
step <- abs(h$breaks[[1]]-h$breaks[[2]])
xfit.lower <- min(h$breaks)-step
xfit.upper <- max(h$breaks)+step
v1.lower <- min(h$mids)
v1.upper <- max(h$mids)
```

## Create curves
### X Values
Determine sequence of x values to calculate the points for the models
```{r xfit}
xfit <- seq(xfit.lower, xfit.upper, length=200)
```
_First number is the minimum bin for the dataset and the second number is the maximum bin, length is number of plots pointed (higher number = smoother curve… to a point)._

### Y Values
Define the curves to be used to calculate the points for plotting
```{r yfit}
yfit1 <- mydata_model$lambda[1]*dnorm(xfit,mean=mydata_model$mu[1],sd=mydata_model$sigma[1])
yfit2 <- mydata_model$lambda[2]*dnorm(xfit,mean=mydata_model$mu[2],sd=mydata_model$sigma[2])
yfit1 <- yfit1*diff(h$mids[1:2])*length(mydata)
yfit2 <- yfit2*diff(h$mids[1:2])*length(mydata)
```

## Plot a pretty graph of the results
### X-axis values
Create a list of values to be used as the x-axis labels, converted from log concentrations relevant to your range of concentrations.
```{r x_axis}
v1 = seq(v1.lower, v1.upper,length=11)
v2 = signif(10^v1, digits=2)
```

### Specify graph labels
```{r, echo=TRUE}
title <- "Plasma 11-ketotestosterone levels in age-2 male spring chinook"  # Graph title
xlab <- "Plasma [11-KT] (ng/mL)" # X-axis label
cutofflab <- "Minijack cutoff" # label for cutoff value on graph
units <- "(ng/mL)" # units for cutoff value
```


### Plot the graph
Plot a pretty graph - SOME OF THE FOLLOWING WILL NEED TO BE TWEAKED TO FIT YOUR DATA/PREFERENCES!!!
```{r pretty_graph}
par(mar=c(5,6,4,1)+.1)
hist(mydata, breaks = 15, density = 10, col = "grey", xaxt="n", xlab = xlab,
     ylim = c(0, ylim.upper), xlim = c(xlim.lower, xlim.upper), main = title, cex.lab=2, cex.axis=1.5, cex.main=2, family = "Times")
lines(xfit, yfit1, col="red", lwd=2)
lines(xfit, yfit2, col="purple", lwd=2)
axis(side = 1, at = v1, labels = v2, cex.axis=1.5, family = "Times")
abline(v=cutoff, col="black", lty=2, lwd=2) # cutoff line
text(cutoff+(step/2),ylim.upper-5, adj = c(0, 1), paste(cutofflab, "\n =", round(10^(cutoff), 2),
      units ), cex=1.5, family = "Times", font = 2)
```

### All figures can be found in the "cutoffvalue_figures" folder. They are exported as PDF, JPEG, and PNG at 300 dpi.
